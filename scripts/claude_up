#!/bin/bash
set -euo pipefail

# Configuration
IMAGE_NAME="claude:latest"
CODE_DIR="$(pwd -P)"
CLAUDE_DATA="claude_data_vol"

# Define Base Mounts
DOCKER_FLAGS=(
    "-it" "--rm"
    "--name" "claude_dev"
    "--cap-add=NET_ADMIN"
    "--env" "DEVCONTAINER=true"
    "--env" "TERM=xterm-256color"
    "-v" "${CODE_DIR}:/root/dev"
    "-v" "${CLAUDE_DATA}:/root/.claude"
    "-v" "${HOME}/.claude.json:/root/.claude.json"
    "-v" "${HOME}/.gitconfig.claude:/root/.gitconfig:ro"
)

# Project Auto-Detection
if [[ -f "Cargo.toml" ]]; then
    echo "Detected Cargo.toml - isolated Rust build target enabled"
    DOCKER_FLAGS+=("-v" "claude_rust_target:/root/rust_target")
    DOCKER_FLAGS+=("-v" "claude_cargo_cache:/usr/local/cargo")
    DOCKER_FLAGS+=("--env" "CARGO_TARGET_DIR=/root/rust_target")
fi

if [[ -f "CMakeLists.txt" ]]; then
    echo "Detected CMakeLists.txt - internal build directory enabled"
    DOCKER_FLAGS+=("-v" "claude_cmake_build:/root/dev/build")
fi

# Flag Parsing
ENABLE_GIT_WRITE=false
for arg in "$@"; do
    case "$arg" in
        -g)
            echo "Git Write Access Enabled (Agents can commit)"
            DOCKER_FLAGS+=("-v" "${CODE_DIR}/.git:/root/dev/.git:rw")
            ENABLE_GIT_WRITE=true
            ;;
        -h|--help)
            echo "Usage: claude_up [OPTIONS]"
            echo "  -g    Enable git write access (removes :ro from .git)"
            echo "  -h    Show this help message"
            exit 0
            ;;
    esac
done

if [ "$ENABLE_GIT_WRITE" = false ]; then
    DOCKER_FLAGS+=("-v" "${CODE_DIR}/.git:/root/dev/.git:ro")
fi

# Launch Container
echo "Launching Claude..."
docker run "${DOCKER_FLAGS[@]}" "$IMAGE_NAME"
