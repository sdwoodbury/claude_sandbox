#!/bin/bash
set -euo pipefail

export CODE_MOUNT="$(pwd)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${SCRIPT_DIR}/.."

# Build compose file array starting with base
COMPOSE_FILES=("-f" "${PROJECT_ROOT}/docker-compose.yml")

# Auto-detect Cargo.toml and add Rust support
if [[ -f "Cargo.toml" ]]; then
    echo "Detected Cargo.toml - enabling Rust support"
    COMPOSE_FILES+=("-f" "${PROJECT_ROOT}/docker-compose.rust.yml")
fi

# Auto-detect CMakeLists.txt and add CMake support
if [[ -f "CMakeLists.txt" ]]; then
    echo "Detected CMakeLists.txt - enabling CMake support"
    COMPOSE_FILES+=("-f" "${PROJECT_ROOT}/docker-compose.cmake.yml")
fi

# Auto-detect helix config and add helix support
if [[ -f "$HOME/.config/helix/config.toml" ]]; then
    echo "Detected helix config - enabling helix support"
    COMPOSE_FILES+=("-f" "${PROJECT_ROOT}/docker-compose.hx.yml")
fi

# Parse flags and add extensions
for arg in "$@"; do
    case "$arg" in
        -g)
            COMPOSE_FILES+=("-f" "${PROJECT_ROOT}/docker-compose.git-rw.yml")
            ;;
        -h)
            echo "Usage: claude_up [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  -g    Enable git write access (for commits)"
            echo "  -h    Show this help message"
            echo ""
            echo "Examples:"
            echo "  claude_up        # Locked-down default"
            echo "  claude_up -g     # Enable git commits"
            exit 0
            ;;
    esac
done

docker compose "${COMPOSE_FILES[@]}" up -d
CONTAINER_ID=$(docker compose "${COMPOSE_FILES[@]}" ps -q claude)

cleanup() {
    echo "Caught exit/interrupt. Running cleanup"
    trap - EXIT SIGINT SIGTERM
    docker compose "${COMPOSE_FILES[@]}" down
    unset CODE_MOUNT
}
trap cleanup EXIT SIGINT SIGTERM

docker exec -it "$CONTAINER_ID" bash
