FROM claude-base:latest

USER root

# 1. Install CMake to /usr/local (invisible to host)
RUN ARCH=$(uname -m) && \
    wget -q https://github.com/Kitware/CMake/releases/download/v3.31.1/cmake-3.31.1-linux-${ARCH}.tar.gz && \
    tar -xvf cmake-3.31.1-linux-${ARCH}.tar.gz --strip-components=1 -C /usr/local && \
    rm cmake-3.31.1-linux-${ARCH}.tar.gz

# 2. Install Rust system-wide
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path && \
    rustup default 1.89.0
ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:$PATH

# 3. THE ISOLATION TRAP
# Force all Rust binaries into the internal volume
ENV CARGO_TARGET_DIR=/home/node/rust_target
RUN mkdir -p /home/node/rust_target && \
    chown node:node /home/node/rust_target

# Force CMake to prefer an internal build directory if Claude uses defaults
ENV CMAKE_BINARY_DIR=/home/node/cmake_build
RUN mkdir -p /home/node/cmake_build && \
    chown node:node /home/node/cmake_build

# must be root for iptables script to work
WORKDIR /home/node/dev
