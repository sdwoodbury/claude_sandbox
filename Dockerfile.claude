FROM ubuntu:24.04

ARG TZ=UTC
ENV TZ="$TZ"
ARG GIT_DELTA_VERSION=0.18.2

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl wget ca-certificates \
    less git procps sudo fzf zsh man-db unzip gnupg2 gh \
    iproute2 dnsutils jq nano vim \
    libssl-dev pkg-config tmux \
    iptables libcap2-bin \
    nodejs npm \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /root

# Git Delta (Architecture Aware)
RUN ARCH=$(dpkg --print-architecture) && \
    wget "https://github.com/dandavison/delta/releases/download/${GIT_DELTA_VERSION}/git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb" && \
    dpkg -i "git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb" && \
    rm "git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb"

RUN npm install -g @anthropic-ai/claude-code

RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

RUN echo 'export ZSH="/root/.oh-my-zsh"' > /root/.zshrc && \
    echo 'plugins=(git fzf)' >> /root/.zshrc && \
    echo 'source $ZSH/oh-my-zsh.sh' >> /root/.zshrc

# Toolchains: CMake & Rust 
RUN ARCH=$(uname -m) && \
    wget -q https://github.com/Kitware/CMake/releases/download/v3.31.1/cmake-3.31.1-linux-${ARCH}.tar.gz && \
    tar -xvf cmake-3.31.1-linux-${ARCH}.tar.gz --strip-components=1 -C /usr/local && \
    rm cmake-3.31.1-linux-${ARCH}.tar.gz

ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:/root/.local/bin:$PATH \
    CARGO_TARGET_DIR=/root/rust_target \
    ENABLE_LSP_TOOLS=1

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path && \
    # Ensure rustup is in path for the current build shell
    /usr/local/cargo/bin/rustup default stable && \
    # for claude rust LSP plugin
    /usr/local/cargo/bin/rustup component add rust-analyzer

# user must install the claude rust analyzer plugins when claude is already logged in. mounting the .claude directory on volume will make this persist

# Setup workspace and directories
RUN mkdir -p /root/rust_target /root/.claude /commandhistory && \
    touch /commandhistory/.bash_history

COPY entrypoint.sh /usr/local/bin/entrypoint.sh

WORKDIR /root/dev
USER root
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
